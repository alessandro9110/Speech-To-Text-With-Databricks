# This is a Databricks asset bundle definition for speech_to_text_asset_bundle.
# See https://docs.databricks.com/dev-tools/bundles/index.html for documentation.
bundle:
  name: speech_to_text_asset_bundle
  uuid: 7c8f3a2e-9d4b-4e1f-a6c5-8b2d7e9f1a3c

include:
  - resources/*.yml
  - resources/*/*.yml


# Variable declarations. These variables are assigned in the dev/prod targets below.
variables:
  catalog:
    description: The catalog to use for Speech To Text With Databrikcs solution.
    default: speech_to_text
  schema:
    description: The schema to use for Speech To Text With Databricks solution.
    default: default
  service_principal_id:
    description: The Application ID (UUID) of the service principal for production


# Targets define different deployment environments (dev, prod, etc.) with their specific configurations.
# Each target can have different settings for run_as, presets, variables, and resource definitions.
# Use 'databricks bundle deploy --target <target_name>' to deploy to a specific environment.
targets:
  dev:
    # See also https://docs.databricks.com/dev-tools/bundles/deployment-modes.html.

    run_as:
      service_principal_name: ${var.service_principal_id}

    default: true

    presets:
      pipelines_development: true # set development to true for pipelines
      trigger_pause_status: PAUSED # set pause_status to PAUSED for all triggers and schedules
      jobs_max_concurrent_runs: 10 # set max_concurrent runs to 10 for all jobs
      tags:
        department: finance

    # Note: workspace.host is not specified here because the bundle automatically uses the workspace where the code is deployed (based on your Databricks CLI profile or current context)
    workspace:
      #host
      root_path: /Workspace/Shared/.bundle/${bundle.name}/${bundle.target}

            # define resouces like: schemas etc.
    resources:
      pipelines:
        stt_bundle_audio_etl:
          name: dev_stt_bundle_audio_etl  # Explicit dev name; avoids name_prefix affecting schema
          configuration:
            catalog: ${var.catalog}
            schema: ${var.schema}
            schema_location_base: /Volumes/${var.catalog}/${var.schema}/files/_schema_metadata

      # Schemas and volumes are managed outside the bundle (already exist in Unity Catalog).
      # Uncomment below only for a fresh environment where these need to be created.
      # schemas:
      #   dev:
      #     name: ${var.schema}
      #     catalog_name: ${var.catalog}
      #     comment: 'Schema for development of speech to text'

      # volumes:
      #   files:
      #     name: files
      #     catalog_name: ${var.catalog}
      #     schema_name: ${var.schema}
      #     volume_type: MANAGED
      #     comment: 'Volume for storing files in development environment'
    

  prod:
    run_as:
      service_principal_name: ${var.service_principal_id}

    presets:
      pipelines_development: false # set development to false for pipelines
      trigger_pause_status: PAUSED # set pause_status to PAUSED for all triggers and schedules
      jobs_max_concurrent_runs: 10 # set max_concurrent runs to 10 for all jobs
      tags:
        department: finance

    mode: production

    # Note: workspace.host is not specified here because the bundle automatically uses the workspace where the code is deployed (based on your Databricks CLI profile or current context)
    workspace:
      #host
      root_path: /Workspace/Shared/.bundle/${bundle.name}/${bundle.target}

    variables:
      catalog: speech_to_text
      schema: prod
    
        # define resouces like: schemas etc.
    resources:
      pipelines:
        stt_bundle_audio_etl:
          name: prod_stt_bundle_audio_etl  # Explicit prod name
          configuration:
            catalog: ${var.catalog}
            schema: ${var.schema}
            schema_location_base: /Volumes/${var.catalog}/${var.schema}/files/_schema_metadata

      schemas:
        prod:
          name: prod
          catalog_name: speech_to_text
          comment: 'Schema for production'


    # OPTIONAL: Grant a human admin CAN_MANAGE on all prod bundle resources.
    # Useful when resources are owned by the service principal but a platform
    # engineer also needs to manage, trigger or modify them from the workspace UI.
    # To activate:
    #   1. Add admin_user_email to the variables section above (no default).
    #   2. Uncomment the block below.
    #   3. Add --var="admin_user_email=${{ vars.ADMIN_USER_EMAIL }}" to the
    #      prod deploy command in .github/workflows/sync_git_folder_and_deploy_adb_prod.yml.
    #permissions:
    #  - user_name: ${var.admin_user_email}
    #    level: CAN_MANAGE
